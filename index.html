<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–†—É–ª–µ—Ç–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div id="tab-content-roulette" class="tab-content active">
    <h1><span>üéÅ</span> –†—É–ª–µ—Ç–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤</h1>
    <div class="roulette-container">
      <div id="roulette" class="roulette"></div>
      <div class="pointer"></div>
    </div>
    <button id="spin">–ö—Ä—É—Ç–∏—Ç—å!</button>
    <div id="result"></div>

    <div class="prize-list-container">
      <h2>–ß—Ç–æ –º–æ–∂–Ω–æ –≤—ã–∏–≥—Ä–∞—Ç—å?</h2>
      <ul id="prize-list">
        <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–æ–≤ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
      </ul>
    </div>
  </div>
  <div id="tab-content-gifts" class="tab-content" style="display:none">
    <h1 style="color:#e91e63;"><span>üéÅ</span> –ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</h1>
    <ul id="my-gifts-list">
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
    </ul>
  </div>
  <div id="tab-content-info" class="tab-content" style="display:none">
    <h1 style="color:#1976d2;"><span>‚ÑπÔ∏è</span> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h1>
    <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.</p>
    <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∫—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É, –≤—ã–∏–≥—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–∑—ã –∏ –≤—ã–≤–æ–¥–∏—Ç—å –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞.</p>
  </div>
  
  <div class="tabs-container">
    <div class="bottom-tabs">
      <button class="tab-btn active" data-tab="roulette"><span class="tab-icon">üé∞</span>–†—É–ª–µ—Ç–∫–∞</button>
      <button class="tab-btn" data-tab="gifts"><span class="tab-icon">üéÅ</span>–ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</button>
      <button class="tab-btn" data-tab="info"><span class="tab-icon">‚ÑπÔ∏è</span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–∏–≥—Ä—ã—à–∞ -->
  <div id="win-modal-overlay" class="modal-overlay">
    <div id="win-modal-content" class="modal-content">
      <img id="win-modal-img" src="" alt="–í—ã–∏–≥—Ä–∞–Ω–Ω—ã–π –ø—Ä–∏–∑">
      <h2 id="win-modal-title"></h2>
      <p id="win-modal-price"></p>
      <button id="win-modal-btn">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–æ–∏–º –ø–æ–¥–∞—Ä–∫–∞–º</button>
    </div>
  </div>

  <!-- –ù–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–¥–∞—Ä–∫–∞ -->
  <div id="withdraw-info-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-icon">üíº</span>
        <h1>–í—ã–≤–æ–¥ –ø–æ–¥–∞—Ä–∫–∞</h1>
      </div>
      <img id="withdraw-info-img" src="" alt="–ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞">
      <h2 id="withdraw-info-title"></h2>
      <div class="info-box">
        <p><strong>–î–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–¥–∞—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:</strong></p>
        <p>–ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –∫ Telegram –¥–ª—è –±–∏–∑–Ω–µ—Å–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –ø—Ä—è–º–æ –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
      </div>
      <p class="info-footer">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è".</p>
      <button id="withdraw-info-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script src="prizes.js"></script>
  <script src="roulette.js"></script>
  <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = {
      roulette: document.getElementById('tab-content-roulette'),
      gifts: document.getElementById('tab-content-gifts'),
      info: document.getElementById('tab-content-info')
    };
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tabContents).forEach(tc => tc.style.display = 'none');
        tabContents[btn.dataset.tab].style.display = '';
      });
    });

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–∑–æ–≤ –ø–æ–¥ —Ä—É–ª–µ—Ç–∫–æ–π
    function generatePrizeList() {
      const prizeList = document.getElementById('prize-list');
      // –§–∏–ª—å—Ç—Ä—É–µ–º "–ü—É—Å—Ç–æ"
      const displayPrizes = prizes.filter(p => p.starPrice > 0);
      
      prizeList.innerHTML = displayPrizes.map(prize => `
        <li>
          <img src="${prize.img}" alt="${prize.name}">
          <span class="prize-list-name">${prize.name}</span>
          <span class="prize-list-price">${prize.starPrice}‚≠ê</span>
        </li>
      `).join('');
    }

    // –í—ã–∑—ã–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', generatePrizeList);

    // –ü—Ä–∏–º–µ—Ä –ø–æ–¥–∞—Ä–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∏ –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    function renderGiftCard(gift, index) {
      return `<li><div class="gift-card">
        <img src="${gift.img}" alt="${gift.name}">
        <div class="gift-card-title">${gift.name}</div>
        <div class="gift-card-date">–í—ã–∏–≥—Ä–∞–Ω: ${gift.date}</div>
        <button class="gift-card-btn" data-gift-index="${index}">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–≤–æ–¥–∞</button>
      </div></li>`;
    }
    function getGiftsFromStorage() {
      // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ, –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
      return []; 
    }
    function updateGiftsList(gifts) { // –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∞—Ä–∫–∏ –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
      document.getElementById('my-gifts-list').innerHTML = gifts.length
        ? gifts.map((gift, index) => renderGiftCard(gift, index)).join('')
        : '<div style="color:#888;margin-top:30px;">–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    }

    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–≤–æ–¥–∞
    const withdrawModalOverlay = document.getElementById('withdraw-info-modal-overlay');
    const withdrawModalImg = document.getElementById('withdraw-info-img');
    const withdrawModalTitle = document.getElementById('withdraw-info-title');
    const withdrawModalBtn = document.getElementById('withdraw-info-btn');

    function showWithdrawModal(gift) {
      withdrawModalImg.src = gift.img;
      withdrawModalTitle.textContent = gift.name;
      withdrawModalOverlay.classList.add('visible');
    }
    
    document.getElementById('my-gifts-list').addEventListener('click', async (e) => {
      if (e.target && e.target.classList.contains('gift-card-btn')) {
        const giftIndex = e.target.dataset.giftIndex;
        // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–¥–∞—Ä–æ–∫ –µ—â–µ —Ç–∞–º
        const response = await fetch(`/api/get_user_status?user_id=${currentUser.id}`);
        const data = await response.json();
        if (data.gifts && data.gifts[giftIndex]) {
          const gift = data.gifts[giftIndex];
          showWithdrawModal(gift);
        }
      }
    });

    withdrawModalBtn.addEventListener('click', () => {
      withdrawModalOverlay.classList.remove('visible');
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(JSON.stringify({action: "show_connection_instructions"}));
        Telegram.WebApp.close();
      }
    });
  </script>
</body>
</html>
